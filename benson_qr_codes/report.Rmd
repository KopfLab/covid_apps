---
output: 
  word_document:
    reference_docx: template1.docx
params:
  rooms: NA
---

```{r, include=FALSE}
rooms <- params$rooms
knitr::opts_chunk$set(include = FALSE)
```

```{r}
# general properties
size <- "400x400"
api <- "http://api.qrserver.com/v1/create-qr-code"
forms <- "https://docs.google.com/forms"
form_id <- "d/e/1FAIpQLSdjnHpnkhpCF6vn8RS_X48pXG4Y3U3DQP_sNo1Yctw56FcmuQ"

# download qr code function
download_qr_code <- function(room, direction) {
  url_params <- c(
    entry.28605957 = room,
    entry.1525768046 = direction
  )
  form_url <- 
    sprintf(
      "%s/%s/formResponse?%s&submit=SUBMIT", forms, form_id,
      paste0(sprintf("%s=%s", names(url_params), purrr::map_chr(url_params, URLencode)), collapse = "&")
    )
  api_url <- sprintf("%s/?data=%s&size=%s", api, URLencode(form_url, reserved = TRUE), size)
  if (!dir.exists("pngs")) dir.create("pngs")
  png_path <- file.path("pngs", paste0(paste0(url_params, collapse = "_"), ".png"))
  download.file(api_url, destfile = png_path)
  return(png_path)
}

# generate enter room
generate_page <- function(room, direction, new_page = TRUE) {
  png_path <- download_qr_code(room = room, direction = direction)
  cat(
    "",
    if (new_page) "##### Line Break",
    "## SCAN BARCODE & SUBMIT LOG *BEFORE* YOU",
    sprintf("# **%s** %s", stringr::str_to_upper(direction), room),
    "",
    sprintf("![](%s)", png_path),
    "",
    "With your smart phone camera app, focus on the barcode for ~1 second and open the google form in a browser when prompted by your phone. Then click submit to log the form. Make sure you are logged in with your IDENTIKEY@colorado.edu account and password (should only need to do this once). To enter this form manually, go to http://colorado.edu/geologicalsciences/covid19",
    "",
    "Thank you for helping keep everyone in Benson safe.",
    "",
    sep = "\n"
  )

}
```

```{r, results="asis", include=TRUE, echo=FALSE}
first_page <- FALSE
for (room in rooms) {
  # generate enter and exit
  generate_page(room, direction = "Enter", new_page = !first_page)
  first_page <- FALSE
  generate_page(room, direction = "Exit", new_page = TRUE)
}
```
